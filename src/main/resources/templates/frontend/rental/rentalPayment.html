<!DOCTYPE html>
<html lang="zxx" data-bs-theme="light">

<head><!-- metas -->
    <meta charset="utf-8">
    <meta name="author" content="pxdraft">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <meta name="keywords" content="ShopApp - eCommerce Bootstrap 5 Template">
    <meta name="description" content="ShopApp - eCommerce Bootstrap 5 Template">
    <!-- title -->
    <title>ShopApp - eCommerce Bootstrap 5 Template</title>
    <!-- Favicon -->
    <link rel="shortcut icon" th:href="@{/logo/favicon.ico}">
    <!-- CSS Template -->
    <th:block th:include="~{frontend/component/plugin/frontendplugin.html :: css}"></th:block>

    <style>

        .hidden {
            display: none !important;
        }

    </style>


</head>

<body>
<!-- 通用插件 -->
<th:block th:replace="frontend/component/plugin/frontendplugin :: components"></th:block>
<!-- 通用插件 -->
<!--
========================
    Wrapper
========================
-->
<div class="wrapper">
    <!-- header height -->
    <div class="header-height-bar" style="min-height: 104.865px;"></div>
    <!-- Header -->
    <header th:replace="frontend/component/header :: header"></header>
    <!-- End Header -->
    <!-- Main -->
    <main>
        <!-- Breadcrumb -->
        <div class="py-3 bg-gray-100">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-6 my-2">
                        <h1 class="m-0 h4 text-center text-lg-start">付款頁面</h1>
                    </div>
                    <div class="col-lg-6 my-2">
                        <ol class="breadcrumb dark-link m-0 small justify-content-center justify-content-lg-end">
                            <li class="breadcrumb-item"><a class="text-nowrap" href="#"><i
                                    class="bi bi-home"></i>首頁</a></li>
                            <li class="breadcrumb-item text-nowrap active" aria-current="page">付款頁面</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div><!-- End Breadcrumb --><!-- Table -->
        <div class="py-6">
            <div class="container">
                <div class="row"><!-- Profile Menu -->

                    <div class="col-lg-4 pb-4 pb-lg-0 col-xxl-3 pe-xxl-5">
                        <div class="bg-body border border-bottom-0 shadow-lg">
                            <div class="d-flex p-3 align-items-center">
                                <!--                                <div class="avatar avatar-lg rounded-circle">-->
                                <!--                                    <img src="../../assets/img/avatar/avatar-home-banner-1.jpg" title="" alt="">-->
                                <!--                                </div>-->
                                <div class="col ps-3">
                                    <h6 class="m-0">購物車明細</h6>
                                    <!--                                    <small>-->
                                    <!--                                        <a href="#">your@email.com</a>-->
                                    <!--                                    </small>-->
                                </div>
                            </div>
                            <div class="bg-gray-200 p-3 border-bottom border-top">
                                <h6 class="m-0">商品</h6>
                            </div>
                            <!-- 464 -->
                            <ul class="list-unstyled mb-0 theme-link itemContainer">

                                <!--                                <li class="border-bottom mb-0">-->
                                <!--                                    <a class="nav-link-style d-flex align-items-center p-3" href="#">-->
                                <!--                                        <i class="bi bi-bag me-2"></i>-->
                                <!--                                        Order-->
                                <!--                                        <div class="ms-auto badge-pill badge bg-secondary">X</div>-->
                                <!--                                    </a>-->
                                <!--                                </li>-->

                            </ul>

                            <div class="bg-gray-200 p-3 border-bottom">
                                <h6 class="m-0">訂單金額</h6>
                            </div>
                            <ul class="list-unstyled mb-0 theme-link">
                                <li class="border-bottom mb-0">
                                    <a class="nav-link-style d-flex align-items-center p-3" id="rentalAllPrice" href="#">
                                        <span>總租金 : </span>
                                        <span class="rentalAllPrice"></span>
                                        <!-- 508 -->
                                    </a>
                                </li>
                                <li class="border-bottom mb-0">
                                    <a class="nav-link-style d-flex align-items-center p-3" id="rentalAllDepPrice" href="#">
                                        <span>總押金 : </span>
                                        <span class="rentalAllDepPrice"></span>
                                        <!-- 508 -->
                                    </a>
                                </li>
                                <li class="border-bottom mb-0">
                                    <a class="nav-link-style d-flex align-items-center p-3" id="totalPrice" href="#">
                                        <span>總計 : </span>
                                        <span class="totalPrice"></span>
                                        <!-- 508 -->
                                    </a>
                                </li>
                            </ul>

                        </div>
                    </div><!-- End Profile Menu --><!-- Content -->

                    <div class="col-lg-8 col-xxl-9">
                        <div class="row g-4">
                            <!-- 第一張卡 -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header py-3 d-flex align-items-center">
                                        <h6 class="m-0">訂購人資料</h6>
                                        <span class="ms-auto">
                                            <img width="40" src="../../assets/img/flags/card-visa.png" title="" alt="">
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-12">
                                                <span class="small letter-spacing-2">姓名</span>
                                                <h6 class="m-0 mt-1" id="byrname">John</h6>
                                            </div>
                                            <div class="col-12">
                                                <span class="small letter-spacing-2">E-mail</span>
                                                <h6 class="m-0 mt-1" id="byremail">John123@gmail.com</h6>
                                            </div>
                                            <div class="col-8">
                                                <span class="small letter-spacing-2">手機號碼</span>
                                                <h6 class="m-0 mt-1" id="byrphone">0912345678</h6>
                                            </div>
                                            <div class="col-8">
                                                <span class="small letter-spacing-2">地址</span>
                                                <h6 class="m-0 mt-1" id="byrAddr">新北市汐止區</h6>
                                            </div>

                                        </div>
                                    </div>
                                    <div class="card-footer d-flex p-3">
                                        <a class="link-mode text-uppercase fw-500" href="#">修改</a>
                                        <a class="link-danger text-uppercase fw-500 ms-auto" href="#"></a>
                                    </div>
                                </div>
                            </div>
                            <!-- 第二張卡 -->
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header py-3 d-flex align-items-center">
                                        <h6 class="m-0">收件人資料</h6>
                                        <span class="ms-auto">
                                            <img width="40" src="../../assets/img/flags/card-visa.png" title="" alt="">
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-12">
                                                <span class="small letter-spacing-2">姓名</span>
                                                <h6 class="m-0 mt-1" id="rcvname">張右翰</h6>
                                            </div>
                                            <div class="col-12">
                                                <span class="small letter-spacing-2">E-mail</span>
                                                <h6 class="m-0 mt-1" id="rcvemail">howardcyh@icloud.com</h6>
                                            </div>
                                            <div class="col-8">
                                                <span class="small letter-spacing-2">手機號碼</span>
                                                <h6 class="m-0 mt-1" id="rcvphone">0923561207</h6>
                                            </div>
                                            <div class="col-8">
                                                <span class="small letter-spacing-2">地址</span>
                                                <h6 class="m-0 mt-1" id="rentalAddr">新北市汐止區</h6>
                                            </div>
                                            <!-- <div class="col-4">-->
                                            <!--     <span class="small letter-spacing-2">手機號碼</span>-->
                                            <!--     <h6 class="m-0 mt-1">0912345678</h6>-->
                                            <!-- </div>-->

                                        </div>
                                    </div>
                                    <div class="card-footer d-flex p-3">
                                        <a class="link-mode text-uppercase fw-500" id="samewith" href="#">同訂購人 </a>
                                        <a class="link-danger text-uppercase fw-500 ms-auto" id="edit-link" href="#">修改</a>
                                    </div>
                                </div>
                            </div>
                            <!-- 第三張卡 -->

                            <!-- 這裡放下一張卡 -->
                        </div>
                        <!-- 結帳卡1 -->
                        <div class="card mt-5">
                            <div class="card-header py-3">
                                <h6 class="m-0">租借資料</h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="row g-3">
                                    <div class="col-sm-6">
                                        <span class="small letter-spacing-2">期望租借日期</span>
                                        <input class="form-control" type="datetime-local" id="cc-number_1"
                                               name="rentalDateNormal" data-format="card" placeholder="Card number" required>
                                    </div>
                                    <div class="col-sm-6">
                                        <span class="small letter-spacing-2">付款方式</span>
                                        <select class="form-control" name="rentalPayMethod">
                                            <option name="1" value="1">線上付款(信用卡)</option>
                                            <option name="2" value="2">現場付款</option>
                                            <option name="3" value="3">Line Pay(僅限到店取貨)</option>
                                        </select>
                                        <form id="formForLinePay" th:action="@{/frontend/rentalorder/linePay}" method="post" style="display: none">
                                            <textarea name="jsonData" style="display:none;"></textarea>
<!--                                            <input type="hidden" name="rentalByrName">-->
<!--                                            <input type="hidden" name="rentalByrPhone">-->
<!--                                            <input type="hidden" name="rentalByrEmail">-->
<!--                                            <input type="hidden" name="rentalRcvName">-->
<!--                                            <input type="hidden" name="rentalRcvPhone">-->
<!--                                            <input type="hidden" name="rentalTakeMethod">-->
<!--                                            <input type="hidden" name="rentalAddr">-->
<!--                                            <input type="hidden" name="rentalPayMethod">-->
<!--                                            <input type="hidden" name="rentalDate">-->
<!--                                            <input type="hidden" name="rentSet">-->
<!--                                            <input type="hidden" name="rentalAllPrice">-->
<!--                                            <input type="hidden" name="rentalAllDepPrice">-->
<!--                                            <input type="hidden" name="buyItems">-->
                                        </form>
                                    </div>

                                    <div class="col-sm-6">
                                        <div class="row">
                                            <div class="col-7 form-group">
                                                <span class="small letter-spacing-2">取貨方式</span>
                                                <select class="form-control" name="rentalTakeMethod">
                                                    <option value="1">店取</option>
                                                    <option value="2">宅配</option>
                                                </select>
                                                <!--                                                <input class="form-control" type="text"-->
                                                <!--                                                                 id="cc-expiry" data-format="date" placeholder="Expiry Date">-->
                                            </div>
                                            <div class="col-5 form-group">
                                                <span class="small letter-spacing-2">租借方案</span>
                                                <select class="form-control" name="rentSet">
                                                    <option value="1">方案 1 (7天)</option>
                                                    <option value="2">方案 2 (14天)</option>
                                                </select>
                                                <!--                                                <input class="form-control" type="password"-->
                                                <!--                                                                 id="cc-cvc" data-format="cvc" placeholder="CVC">-->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <span class="small letter-spacing-2">歸還日期(若期望日期為首日) : </span>
                                        <span id="return-date"></span>
                                        <button class="btn btn-primary d-block w-100 createOrder" type="button" >
                                            確認結帳 <!-- 565 -->
                                        </button>
                                        <button class="btn btn-primary d-block w-100 linePay hidden" type="button" >
                                            Line Pay結帳 <!-- 565 -->
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 結帳卡2 -->

                        <!-- 結帳卡 2 結束 -->

                    </div>
                    <!-- 動態加載的表單將放在這個div中 -->
                    <div id="ecpayFormContainer"></div>
                    <!-- End Content -->
                </div>
            </div>
        </div>
    </main>
    <!-- End Main -->
    <!-- Footer -->
    <footer th:replace="frontend/component/footer :: footer"></footer>
    <!-- End Footer -->
</div>
<!--
========================
   End Wrapper
========================
-->
<!-- script start -->
<th:block th:insert="~{frontend/component/plugin/frontendplugin.html :: js}"></th:block>
<!-- End script start -->
</body>

<script>

    $(function () {

        let baseUrl = window.location.protocol + "//" + window.location.host;
        let apiPath = "/frontend/rentalorder/";
        let rentalAllPrice = 0;
        let rentalAllDepPrice = 0;
        let items = [];

        function getAll() {

            items.length = 0;
            rentalAllPrice = 0;
            rentalAllDepPrice = 0;

            fetch(baseUrl + apiPath + "getFromCart")
                .then(function (response) {
                    return response.json();
                }).then(function (data) {
                    if (data === "/frontend/member/loginMember") {
                        window.location.href = data;
                    }
                    let itemContainer = $(".itemContainer");
                    itemContainer.empty();
                    let totalItems = Object.keys(data).length; // 計算購物車商品數量
                    $("span[data-cart-items]").attr("data-cart-items", totalItems); // 更新購物車商品數量圖示

                    /*
                     * 遍歷陣列裡每個元素，每個元素都是一對 key, item，以下舉例 :
                     * [陣列1, 陣列2]
                     * 陣列1 => ["member : 1 : cartItem : 5011", {rentalCatNo : "5", rentalColor : "深卡其色"...}]
                    */
                    Object.entries(data).forEach(([key, item]) => {

                        if (item.rentalStat === "0") {

                            items.push(item.rentalNo);
                            rentalAllPrice += parseFloat(item.rentalPrice);
                            rentalAllDepPrice += parseFloat(item.rentalDesPrice);

                            // 拼接結帳頁面小明細 74

                            let cartItem = $("<li>", {
                                "class" : "border-bottom mb-0",
                                "data-rentalNo" : item.rentalNo
                            }).appendTo(itemContainer);
                            let a = $("<a>", {
                                "class" : "nav-link-style d-flex align-items-center p-3",
                                "href" : "#"
                            }).appendTo(cartItem);
                            let i = $("<i>", {
                                "class" : "bi bi-bag me-2"
                            }).appendTo(a);
                            let itemName = $("<span>", {
                                "text" : item.rentalName
                            }).appendTo(a);
                            let delBtn = $("<div>", {
                                "class" : "ms-auto badge-pill badge bg-secondary delBtn",
                                "text" : "X"
                            }).appendTo(a);

                        }

                    });

                    $("span.rentalAllPrice").text(rentalAllPrice);
                    $("span.rentalAllDepPrice").text(rentalAllDepPrice);
                    $("span.totalPrice").text( (rentalAllPrice + rentalAllDepPrice) );

            });

        } // getAll()結束
        // 進來頁面就先取一次
        getAll();

        // 依據所選付款方式來顯示長相一樣但作用不同的按鈕
        $("select[name='rentalPayMethod']").on("change", function () {
            if ($("select[name='rentalPayMethod']").val() === "3") {
                $("button.createOrder").addClass("hidden");
                $("button.linePay").removeClass("hidden");
            } else {
                $("button.createOrder").removeClass("hidden");
                $("button.linePay").addClass("hidden");
            }
        });

        // line pay 結帳
        $(document).on("click", "button.linePay", function () {

            if (items.length === 0) {
                alert("好像沒有商品可以結帳喔!再去逛逛吧!");
                return;
            }
            let rentalDate = $("input[name='rentalDateNormal']").val();
            let rentalTakeMethod = $("select[name='rentalTakeMethod']").val();
            let rentalPayMethod = $("select[name='rentalPayMethod']").val();
            if (rentalTakeMethod === "2" && rentalPayMethod === "2") {
                alert("溫馨提醒 : 宅配方式只接受線上付款喔");
                return;
            }
            if (rentalDate === "") {
                alert("請輸入日期!");
                return;
            }
            if (rentalTakeMethod === "2") {
                alert("溫馨提醒 : 目前Line Pay只支援現場取貨方式喔");
                return;
            }

            // $("input[name='rentalByrName']").val($("h6#byrname").text());
            // $("input[name='rentalByrPhone']").val($("h6#byrphone").text());
            // $("input[name='rentalByrEmail']").val($("h6#byremail").text());
            // $("input[name='rentalRcvName']").val($("h6#rcvname").text());
            // $("input[name='rentalRcvPhone']").val($("h6#rcvphone").text());
            // $("input[name='rentalTakeMethod']").val(rentalTakeMethod);
            // $("input[name='rentalAddr']").val($("h6#rentalAddr").text());
            // $("input[name='rentalPayMethod']").val(rentalPayMethod);
            // $("input[name='rentalDate']").val(rentalDate);
            // $("input[name='rentSet']").val($("select[name='rentSet']").val());
            // $("input[name='rentalAllPrice']").val($("span.rentalAllPrice").text());
            // $("input[name='rentalAllDepPrice']").val($("span.rentalAllDepPrice").text());
            // $("input[name='buyItems']").val(JSON.stringify(items));
            var jsonData = {
                rentalByrName: $("h6#byrname").text(),
                rentalByrPhone: $("h6#byrphone").text(),
                rentalByrEmail: $("h6#byremail").text(),
                rentalRcvName: $("h6#rcvname").text(),
                rentalRcvPhone: $("h6#rcvphone").text(),
                rentalTakeMethod: rentalTakeMethod,
                rentalAddr: $("h6#rentalAddr").text(),
                rentalPayMethod: rentalPayMethod,
                rentalDate: rentalDate,
                rentSet: $("select[name='rentSet']").val(),
                rentalAllPrice: $("span.rentalAllPrice").text(),
                rentalAllDepPrice: $("span.rentalAllDepPrice").text(),
                buyItems: items  // 這裡假設items已經是一個物件或數組
            };

            $("textarea[name='jsonData']").val(JSON.stringify(jsonData));
            $("form#formForLinePay").submit();

        });


        // 從明細刪除商品
        $(document).on("click", ".delBtn", function () {

            let rentalNo = $(this).closest("li.mb-0").attr("data-rentalNo");
            let rentalNos = [rentalNo];
            let data = {
                "rentalNos" : rentalNos
            };

            if (confirm("確定要刪除?")) {

                fetch(baseUrl + apiPath + "deleteFromCart", {
                    method : "POST",
                    headers : {
                        "Content-Type" : "application/json"
                    },
                    body : JSON.stringify(data)
                }).then(function (response) {
                    return response.text();
                }).then(function (data) {
                    if (data === "ok") {
                        alert("刪除成功");
                        getAll();
                    } else {
                        window.location.href = data;
                    }
                });

            }

        }); // 從明細刪除商品 結束

        // 修改收件人資料
        $("#edit-link").click(function (e) {

            e.preventDefault(); // 防止頁面跳轉

            if ($(this).text() === "修改") {

                // 把 h6 標籤轉換成 input 欄位
                ["rcvname", "rcvemail", "rcvphone", "rentalAddr"].forEach(function (id) {
                    let currentValue = $("#" + id).text();
                    $('#' + id).replaceWith(`<input id="${id}" class="form-control" value="${currentValue}">`);
                });
                $(this).text("儲存");

            } else {

                // 保存 input 的值，並把 input 轉換回 h6 標籤
                ["rcvname", "rcvemail", "rcvphone", "rentalAddr"].forEach(function (id) {
                    let inputValue = $("#" + id).val();
                    $('#' + id).replaceWith(`<h6 class="m-0 mt-1" id="${id}">${inputValue}</h6>`);
                });
                $(this).text("修改");

            }

        }); // 修改收件人資料 結束

        // 同訂購人資料結束
        $("#samewith").click(function (e) {

            e.preventDefault();

            let byrname = $("#byrname").text();
            let byremail = $("#byremail").text();
            let byrphone = $("#byrphone").text();

            $("#rcvname").text(byrname);
            $("#rcvemail").text(byremail);
            $("#rcvphone").text(byrphone);

        }); // 同訂購人資料 結束

        // 讓日期動態變化
        $("#cc-number_1, select[name='rentSet']").change(function () {

            let rentalDate = $("#cc-number_1").val();
            let rentDuration = $("select[name='rentSet']").find("option:selected").text().match(/\d+/);

            if (rentalDate && rentDuration) {
                // rentDuration = parseInt(rentDuration[0]);
                if ( parseInt(rentDuration[0]) === 1 ) {
                    rentDuration = 7;
                } else {
                    rentDuration = 14;
                }
                let endDate = caculateReturnDate(rentalDate, rentDuration);
                $("#return-date").text(endDate);
            }

        }); // 讓日期動態變化 結束

        // 計算預計歸還日期
        function caculateReturnDate(start, days) {

            let startDate = new Date(start);
            startDate.setDate(startDate.getDate() + days); // 增加天數

            // 格式化日期
            let year = startDate.getFullYear();
            let month = ("0" + (startDate.getMonth() + 1)).slice(-2);
            let day = ("0" + startDate.getDate()).slice(-2);
            let hours = ("0" + startDate.getHours()).slice(-2);
            let minutes = ("0" + startDate.getMinutes()).slice(-2);

            return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes;

        } // 計算預計歸還日期 結束

        // 結帳 242
        $(document).on("click", "button.createOrder", function () {

            if (items.length === 0) {
                alert("好像沒有商品可以結帳喔!再去逛逛吧!");
                return;
            }
            // console.log("第一道檢查完時 : " + rentalAllDepPrice);

            let rentalDate = $("input[name='rentalDateNormal']").val();
            let rentalTakeMethod = $("select[name='rentalTakeMethod']").val();
            let rentalPayMethod = $("select[name='rentalPayMethod']").val();
            let reqUrl = "createOrder";

            if (rentalTakeMethod === "2" && rentalPayMethod === "2") {
                alert("溫馨提醒 : 宅配方式只接受線上付款喔");
                return;
            }
            if (rentalDate === "") {
                alert("請輸入日期!");
                return;
            }

            // 創建訂單所需資料
            let formData = {
                rentalByrName : $("h6#byrname").text(),
                rentalByrPhone : $("h6#byrphone").text(),
                rentalByrEmail : $("h6#byremail").text(),
                rentalRcvName : $("h6#rcvname").text(),
                rentalRcvPhone : $("h6#rcvphone").text(),
                rentalTakeMethod : rentalTakeMethod,
                rentalAddr : $("h6#rentalAddr").text(),
                rentalPayMethod : rentalPayMethod,
                rentalDate : rentalDate,
                rentSet : $("select[name='rentSet']").val(),
                rentalAllPrice : $("span.rentalAllPrice").text(),
                rentalAllDepPrice : $("span.rentalAllDepPrice").text(),
                buyItems : items
            };

            fetch(baseUrl + apiPath + reqUrl, {
                method : "POST",
                headers : {
                    "Content-Type" : "application/json"
                },
                body : JSON.stringify(formData)
            }).then(function (response) {
                return response.text();
            }).then(function (checkoutUrl) {
                if (checkoutUrl === "/frontend/member/loginMember") { // 若還沒登入，導向至登入頁面
                    window.location.href = baseUrl + checkoutUrl;
                } else if (checkoutUrl === "thankForBuying") { // 若選現場付款，直接導向至感謝購買頁面
                    window.location.href = baseUrl + apiPath + checkoutUrl;
                }
                let formContainer = document.getElementById("ecpayFormContainer");
                formContainer.innerHTML = checkoutUrl;
                formContainer.querySelector('form').submit();
            });

        }); // 結帳 結束


    }); // DOMContentLoaded結束

</script>

</html>