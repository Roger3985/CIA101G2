<!DOCTYPE html>
<html lang="zxx" data-bs-theme="light">

<head><!-- metas -->
    <meta charset="utf-8">
    <meta name="author" content="pxdraft">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <meta name="keywords" content="ShopApp - eCommerce Bootstrap 5 Template">
    <meta name="description" content="ShopApp - eCommerce Bootstrap 5 Template">
    <!-- title -->
    <title>ShopApp - eCommerce Bootstrap 5 Template</title>
    <!-- Favicon -->
    <link rel="shortcut icon" th:href="@{/logo/favicon.ico}">
    <!-- CSS Template -->
    <link th:href="@{/frontend/assets/css/style.css}" rel="stylesheet">

    <style>

        .disabled-item {
            position: relative; /* 確保能夠容納絕對定位的子元素 */
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7); /* 白色半透明 */
            color: black; /* 文本顏色改為黑色以增強可讀性 */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            pointer-events: none; /* 禁用遮罩層上的點擊事件，以允許對底層元素進行操作 */
        }

        /* 遮罩層內的按鈕樣式 */
        .overlay button {
            pointer-events: auto; /* 啟用按鈕的點擊事件 */
        }


    </style>

</head>

<body>
<!-- 通用插件 -->
<th:block th:replace="frontend/component/plugin/frontendplugin :: components"></th:block>
<!-- 通用插件 -->
    <!--
    ========================
        Wrapper
    ========================
    -->
    <div class="wrapper">
        <!-- Header -->
        <header th:replace="frontend/component/header :: header"></header>
        <!-- End Header -->
        <!-- Main -->
        <main>
            <!-- Page Title -->
            <div class="bg-no-repeat bg-cover bg-right-center position-relative"
                 th:style="|background-image: url(@{../../resources/static/frontend/assets/img/fashion3/home-banner-6.jpg});|">
                <div class="position-absolute top-0 end-0 start-0 bottom-0 opacity-3 bg-dark"></div>
                <!-- Header Height Bar -->
                <div class="header-height-bar border-bottom opacity-3" style="min-height: 104.865px;"></div>
                <div class="container py-6 position-relative">
                    <div class="row align-items-center">
                        <div class="col-lg-6 my-2">
                            <h1 class="m-0 h4 text-center text-lg-start text-white">你的購物車</h1>
                        </div>
                        <div class="col-lg-6 my-2">
                            <ol
                                class="breadcrumb breadcrumb-light m-0 small justify-content-center justify-content-lg-end">
                                <li class="breadcrumb-item"><a class="text-nowrap" href="#">首頁</a></li>
                                <li class="breadcrumb-item text-nowrap active" aria-current="page">你的購物車</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Page Title -->
            <!-- Section -->
            <section class="section">
                <div class="container">
                    <div class="row gy-4">
                        <!-- Cart Items -->
                        <div class="col-lg-8 cartItems">
                            <div class="d-flex justify-content-between align-items-center pb-4 border-bottom mb-4">
                                <h2 class="h5 mb-0">商品</h2><a class="btn btn-outline-primary btn-sm ps-2"
                                    th:href="@{/frontend/rental/rentalShop}"><i class="ci-arrow-left me-2"></i>繼續購物</a>
                            </div>

                                <!--拿來裝購物車商品的 div-->
                            <div id="cartItemsContainer"></div>

                            <button class="btn btn-primary d-block w-100 mt-4 btn_delCantRent" type="button">
<!--                                <i class="bi-arrow-repeat fs-base me-2"></i>-->
                                點按以刪除不能租借的商品
                            </button>
                        </div>
                        <!-- Cart Sidebar -->
                        <div class="col-lg-4 ps-xl-7">
                            <!-- Shipping estimates -->
                            <div class="card mb-4">
                                <div class="card-header bg-transparent py-3">
                                    <h6 class="m-0 h5">Shipping estimates</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3"><select class="form-select" required="">
                                            <option value="">Choose your country</option>
                                            <option value="Australia">Australia</option>
                                            <option value="Belgium">Belgium</option>
                                            <option value="Canada">Canada</option>
                                            <option value="Finland">Finland</option>
                                            <option value="Mexico">Mexico</option>
                                            <option value="New Zealand">New Zealand</option>
                                            <option value="Switzerland">Switzerland</option>
                                            <option value="United States">United States</option>
                                        </select>
                                        <div class="invalid-feedback">Please choose your country!</div>
                                    </div>
                                    <div class="mb-3"><select class="form-select" required="">
                                            <option value="">Choose your city</option>
                                            <option value="Bern">Bern</option>
                                            <option value="Brussels">Brussels</option>
                                            <option value="Canberra">Canberra</option>
                                            <option value="Helsinki">Helsinki</option>
                                            <option value="Mexico City">Mexico City</option>
                                            <option value="Ottawa">Ottawa</option>
                                            <option value="Washington D.C.">Washington D.C.</option>
                                            <option value="Wellington">Wellington</option>
                                        </select>
                                        <div class="invalid-feedback">Please choose your city!</div>
                                    </div>
                                    <div class="mb-3"><input class="form-control" type="text"
                                            placeholder="ZIP / Postal code" required="">
                                        <div class="invalid-feedback">Please provide a valid zip!</div>
                                    </div>
                                    <button class="btn btn-outline-primary d-block w-100" type="submit">Calculate
                                        shipping
                                    </button>
                                </div>
                            </div>
                            <!-- Order Total -->
                            <div class="card">
                                <div class="card-header bg-transparent py-3">
                                    <h6 class="m-0 h5">小計(可結帳)</h6>
                                </div>
                                <div class="card-body">

                                    <ul class="list-unstyled">
                                        <li class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="me-2 text-body">總租金</h6>
                                            <span class="text-end rentalAllPrice"></span>
                                        </li>
                                        <li class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="me-2 text-body">總押金</h6>
                                            <span class="text-end rentalAllDepPrice"></span>
                                        </li>
                                        <li
                                            class="d-flex justify-content-between align-items-center border-top pt-3 mt-3">
                                            <h6 class="me-2">合計</h6>
                                            <span class="text-end text-mode totalPrice"></span>
                                        </li>
                                    </ul>
                                    <div class="d-grid gap-2 mx-auto">
                                        <a class="btn btn-primary" href="/backend/rentalorder/toRentalPayment">
                                            <i class="bi-credit-card-2-back me-2"></i>準備結帳
                                        </a>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- End Section -->
        </main>
        <!-- End Main -->
        <!-- Footer -->
        <footer th:replace="frontend/component/footer :: footer"></footer>
        <!-- End Footer -->
    </div>
    <!--
    ========================
       End Wrapper
    ========================
    -->
    <!-- script start -->
    <th:block th:insert="~{frontend/component/plugin/frontendplugin.html :: js}"></th:block>
    <!-- End script start -->
</body>

<script>

    $(function () {

        let baseUrl = window.location.protocol + "//" + window.location.host;
        let apiPath = "/backend/rentalorder";
        let memNo = 1;
        let rentalAllPrice = 0;
        let rentalAllDepPrice = 0;

        function getAll() {

            rentalAllPrice = 0;
            rentalAllDepPrice = 0;

            fetch(baseUrl + apiPath + "/getFromCart?memNo=" + memNo)
                .then(function (response) {
                    return response.json();
                }).then(function (data) {

                const container = $("div#cartItemsContainer");
                container.empty();  // 清除先前的内容

                let totalItems = Object.keys(data).length; // 計算購物車商品數量
                $("span[data-cart-items]").attr("data-cart-items", totalItems); // 更新購物車商品數量圖示
                // console.log(data);
                // console.log(Object.entries(data));
               /* 遍歷陣列裡每個元素，每個元素都是一對 key, item，以下舉例
                *
                * [陣列1, 陣列2]
                * 陣列1 => ["member : 1 : cartItem : 5011", {rentalCatNo : "5", rentalColor : "深卡其色"...}]
               */
                Object.entries(data).forEach(([key, item]) => {

                    let rentalSize = "";
                    switch (item.rentalSize) { // 把 size 數字換成對應英文
                        case "0" :
                            rentalSize = "XS"
                            break;
                        case "1" :
                            rentalSize = "S"
                            break;
                        case "2" :
                            rentalSize = "M"
                            break;
                        case "3" :
                            rentalSize = "L"
                            break;
                        case "4" :
                            rentalSize = "XL"
                            break;
                        case "5" :
                            rentalSize = "2L"
                            break;
                    }

                    // 創造一個 div，並給予模板需要的 class

                    // 創建商品被借走時的特效物件

                    let productDiv = $("<div>", {
                        "class" : "d-flex align-items-center flex-row w-100 pb-3 mb-3 border-bottom cartItem",
                        "data-rentalNo" : item.rentalNo,
                    });

                    if (item.rentalStat !== "0") {
                        productDiv.addClass("disabled-item");
                        let rentalNo = item.rentalNo;

                        let overlayDiv = $("<div>", {
                            "class" : "overlay"
                        }).appendTo(productDiv);

                        $("<span>", {
                            "text": "商品被搶先預約了...還是先加入追蹤?",
                            "class": "overlay-text"
                        }).appendTo(overlayDiv);

                        $("<button>", {
                            "class": "btn btn-sm btn-light btn_addTrack",
                            "text": "追蹤",
                            "click": function(e) {

                                e.preventDefault();
                                let target = $(e.target);
                                let apiPath = "/frontend/rentalmytrack/addTrack";
                                let data = {
                                    rentalNo : rentalNo,
                                    memNo : memNo
                                };

                                fetch(baseUrl + apiPath, {
                                    method : "POST",
                                    headers : {
                                        "Content-Type" : "application/json"
                                    },
                                    body : JSON.stringify(data)
                                }).then(response => response.text())
                                    .then(rentalName => {
                                        target.closest("div.overlay").find("span.successMsg").text("已加入追蹤!").fadeIn(0).delay(500).fadeOut(500);
                                    });

                            }
                        }).appendTo(overlayDiv);
                        $("<span>", {
                            "class" : "successMsg",
                            "style" : "color : green"
                        }).appendTo(overlayDiv);

                    }


                    // 繼續創建正常商品資訊物件

                    let link = $("<a>" , {
                        "class" : "d-inline-block flex-shrink-0 me-3",
                        "href" : "#"
                    }).appendTo(productDiv);
                    let img = $("<img>", {
                        "src" : "/icons/frontend/rental/rentalshop/" + item.rentalNo + ".jpg",
                        "width" : "120",
                        "alt" : "Product"
                    }).appendTo(link);
                    let infoDiv = $("<div>", {
                        "class" : "d-flex flex-column flex-sm-row col"
                    }).appendTo(productDiv);
                    let detailsDiv = $("<div>", {
                        "class" : "pe-sm-2"
                    }).appendTo(infoDiv);
                    let title = $("<h3>", {
                        "class" : "product-title fs-5 mb-1"
                    }).appendTo(detailsDiv);
                    let titleLink = $("<a>", {
                        "class" : "",
                        "href" : "#",
                        "text" : item.rentalName
                    }).appendTo(title);
                    let sizeDiv = $("<div>", {
                        "class" : "small",
                        "html" : "<span class=\"text-muted me-2\">尺寸 :</span>" + rentalSize
                    }).appendTo(detailsDiv);
                    let colorDiv = $("<div>", {
                        "class" : "small",
                        "html" : "<span class=\"text-muted me-2\">顏色 :</span>" + item.rentalColor
                    }).appendTo(detailsDiv);
                    let quanDiv = $("<div>", {
                        "class" : "small",
                        "html" : "<span class=\"text-muted me-2\">數量 : 1</span>"
                    }).appendTo(detailsDiv);
                    let priceDiv = $("<div>", {
                        "class" : "lead pt-1",
                        "text" : item.rentalPrice
                    }).appendTo(detailsDiv);
                    // 114
                    let actionDiv = $("<div>", {
                        "class": "pt-2 pt-sm-0 d-flex d-sm-block ms-sm-auto"
                    }).appendTo(infoDiv);
                    let qtyLabel = $("<label>", {
                        "class": "form-label d-none d-sm-inline-block",
                        "text": ""
                    }).appendTo(actionDiv);
                    let removeBtn = $("<button>", {
                        "class": "btn btn-link px-0 text-danger ms-auto",
                        "style" : "margin-top: 30px",
                        "type": "button",
                        "html": "<i class='bi-trash3 me-2 delItem'></i><span class='delItem'>移除</span>"
                    }).appendTo(actionDiv);

                    container.append(productDiv);

                    if (item.rentalStat === "0") {
                        rentalAllPrice += parseFloat(item.rentalPrice);
                        rentalAllDepPrice += parseFloat(item.rentalDesPrice);
                    }

                });

                $("span.rentalAllPrice").text(rentalAllPrice);
                $("span.rentalAllDepPrice").text(rentalAllDepPrice);
                $("span.totalPrice").text( (rentalAllPrice + rentalAllDepPrice) );

            });

        } // getAll()結束
        getAll();

        // $("button.refBtn").on("click", function () {
        //     getAll();
        // });

        // 刪除單個購物車商品
        $(document).on("click", ".delItem", function () {

            let rentalNos = [];
            let rentalNo = $(this).closest("div.cartItem").attr("data-rentalNo");
            rentalNos.push(rentalNo);
            let data = {
                "rentalNos" : rentalNos,
                "memNo" : memNo
            };

            if (confirm("確定從購物車刪除?")) {

                fetch(baseUrl + apiPath + "/deleteFromCart", {
                    method : "POST",
                    headers : {
                        "Content-Type" : "application/json"
                    },
                    body : JSON.stringify(data)
                }).then(function (response) {
                    return response.text();
                }).then(function (data) {
                    if (data === "ok") {
                        alert("刪除成功");
                        getAll();
                    }
                });

            }

        }); // 刪除單個購物車商品結束

        // 刪除全部 不能租借的商品
        $(document).on("click", "button.btn_delCantRent", function () {

            let cartItems = $(this).closest("div.cartItems");
            let disabledItems = cartItems.find("div.disabled-item");
            let rentalNos = [];

            for (let i = 0; i < disabledItems.length; i++) {
                rentalNos.push($(disabledItems[i]).attr("data-rentalno"));
            }
            if (rentalNos.length === 0) {
                alert("還沒有商品能刪...");
                return;
            }
            // console.log(rentalNos);
            let data = {
                "rentalNos" : rentalNos,
                "memNo" : memNo
            };

            if (confirm("確定刪除尚不可租借的商品?")) {

                fetch(baseUrl + apiPath + "/deleteFromCart", {
                    method : "POST",
                    headers : {
                        "Content-Type" : "application/json"
                    },
                    body : JSON.stringify(data)
                }).then(function (response) {
                    return response.text();
                }).then(function (data) {
                    if (data === "ok") {
                        alert("刪除成功");
                        getAll();
                    }
                });

            }

        }); // 刪除全部 不能租借的商品 結束


    }); // DOMContentLoaded結束

</script>

</html>