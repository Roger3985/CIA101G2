<!-- Profile Menu -->
<div class="col-lg-4 pb-4 pb-lg-0 col-xxl-3 pe-xxl-5">
    <div class="bg-body border border-bottom-0 shadow-lg">
        <div class="d-flex p-3 align-items-center">
            <div class="avatar-container">
                <div class="avatar avatar-lg rounded-circle">
                    <img th:src="@{/frontend/member/picture(memno=${session.loginsuccess.getMemNo()})}"
                         style="width: 80px; height: 80px; border: 1px solid #ccc;"
                         alt="會員大頭貼"
                         th:if="${session.loginsuccess}">
                </div>
                <!-- 第一個表單，用於選擇圖片 -->
                <div class="col-auto">
                    <label class="avatar-label">
                        <i class="bi bi-camera camera-icon"></i>
                    </label>
                </div>
            </div>
            <div class="col ps-3">
                <h6 class="m-0"><a th:href="@{/frontend/member/newMemberName}" style="color: #6c757d;">
                    <th th:text="${session.loginsuccess.getMemName()}" readonly>
                </a></h6>
                <small>
                    <a th:href="@{/frontend/member/newMemberMail}">
                        <th th:text="${session.loginsuccess.getMemMail()}" readonly></th>
                    </a>
                </small>
            </div>
            <form method="post" th:action="@{/frontend/member/newPicture}" enctype="multipart/form-data"
                  onsubmit="return handleAvatarUpload(event)" class="row g-3 align-items-center">
                <!--                                        <label for="avatarInput" class="col-auto col-form-label" style="display: none">Change Profile Photo</label>-->
                <label for="avatarInput" class="col-auto col-form-label" style="display: none"></label>
                <div class="col-auto" style="display: none">
                    <input type="file" name="chaPic" class="form-control" id="avatarInput" accept="image/*">
                </div>
                <div class="col-auto">
                    <input type="submit" value="確認上傳新圖片" class="form-control btn btn-primary"
                           style="font-size: 0.8em; padding: 5px 10px;">
                </div>
            </form>
        </div>
        <div class="bg-gray-200 p-3 border-bottom border-top">
            <h6 class="m-0">個人清單</h6>
        </div>
        <ul class="list-unstyled mb-0 theme-link">
            <li class="border-bottom mb-0">
                <a class="nav-link-style d-flex align-items-center p-3"
                   th:href="@{/frontend/productorder/CartEnd}">
                    <i class="bi bi-bag me-2"></i> 商品訂單
<!--                <div class="ms-auto badge-pill badge bg-secondary">5</div>-->
                </a>
            </li>
            <li class="border-bottom mb-0">
                <a class="nav-link-style d-flex align-items-center p-3"
                   th:href="@{/frontend/rentalorder/toMemberRentalOrders}">
                    <i class="bi bi-bag me-2"></i> 租借訂單
                    <div class="ms-auto badge-pill badge bg-secondary">5</div>
                </a>
            </li>
            <li class="border-bottom mb-0">
                <a class="nav-link-style d-flex align-items-center p-3"
                    th:href="@{/frontend/productmyfavorite/myProductFAV}"><i class="fi-heart me-2"></i>我的最愛(商品)
<!--                    <div class="ms-auto badge-pill badge bg-secondary">5</div>-->
                </a>
            </li>
            <li class="border-bottom mb-0">
                <a class="nav-link-style d-flex align-items-center p-3"
                   th:href="@{/frontend/rentalmyfavorite/myRentalFAV}"><i class="fi-heart me-2"></i>我的最愛 (租借品)
                    <div class="ms-auto badge-pill badge bg-secondary">5</div>
                </a>
            </li>
            <li class="border-bottom mb-0"><a class="nav-link-style d-flex align-items-center p-3"
                                              th:href="@{/frontend/mycoupon/mycouponlist}">
                <i class="bi bi-bookmark me-2"></i>我的優惠券
                <div class="ms-auto badge-pill badge bg-secondary" th:text="${myCouponQTY}"></div>
            </a></li>
            <li class="border-bottom mb-0">
                <a class="nav-link-style d-flex align-items-center p-3"
                   th:href="@{/frontend/notice/memberNoticeData}"><i class="bi bi-bell me-2"></i>訊息通知
                    <div class="ms-auto badge-pill badge bg-secondary" th:text="${session.unreadNoticeCount}"></div>
                </a></li>
            <!--            <li class="border-bottom mb-0">-->
            <!--                <a class="nav-link-style d-flex align-items-center p-3"-->
            <!--                   th:href="@{/frontend/notice/memberNoticeData}"><i class="bi bi-clipboard2-heart me-2"></i>ColumnArticle Collection-->
            <!--                    <div class="ms-auto badge-pill badge bg-secondary" th:text="${session.unreadNoticeCount}"></div>-->
            <!--                </a></li>-->
            <!--            <li class="border-bottom mb-0">-->
            <!--                <a class="nav-link-style d-flex align-items-center p-3"-->
            <!--                   th:href="@{/frontend/click/memberClickLike}"><i class="bi bi-search-heart me-2"></i>ColumnArticle ClickLike-->
            <!--                    <div class="ms-auto badge-pill badge bg-secondary" th:text="${session.unreadNoticeCount}"></div>-->
            <!--                </a></li>-->
            <!--            <li class="border-bottom mb-0">-->
            <!--                <a class="nav-link-style d-flex align-items-center active p-3"-->
            <!--                   th:href="@{/frontend/notice/memberNoticeData}"><i class="bi bi-bell me-2"></i>Notices</a>-->
            <!--                <div class="ms-auto badge-pill badge bg-secondary">0</div>-->
            <!--            </li>-->
        </ul>
        <div class="bg-gray-200 p-3 border-bottom">
            <h6 class="m-0">帳號設定</h6>
        </div>
        <ul class="list-unstyled mb-0 theme-link">
            <li class="border-bottom mb-0"><a
                    class="nav-link-style d-flex align-items-center active p-3"
                    th:href="@{/frontend/member/memberData}"><i class="fi-user me-2"></i>個人資訊</a>
            </li>
            <li class="border-bottom mb-0"><a
                    class="nav-link-style d-flex align-items-center active p-3"
                    th:href="@{/frontend/member/updateData}"><i class="fi-user me-2"></i>更新個人資訊</a>
            </li>
            <li class="border-bottom mb-0"><a
                    class="nav-link-style d-flex align-items-center p-3"
                    th:href="@{/frontend/member/newPassword}"><i class="bi bi-key me-2"></i></i>密碼</a>
            </li>
            <li class="border-bottom mb-0"><a
                    class="nav-link-style d-flex align-items-center p-3"
                    th:href="@{/frontend/member/newMemberAddress}"><i class="bi bi-map-fill me-2"></i>地址</a>
            </li>
            <li class="border-bottom mb-0"><a
                    class="nav-link-style d-flex align-items-center p-3"
                    th:href="@{/frontend/member/newMemberCreditCard}"><i
                    class="bi bi-credit-card me-2"></i>信用卡</a></li>
            <li class="border-bottom mb-0"><a
                    class="nav-link-style d-flex align-items-center p-3" th:href="@{/frontend/member/logoutMember}"><i
                    class="bi bi-box-arrow-left me-2"></i>登出</a>
            </li>
        </ul>
    </div>
</div><!-- End Profile Menu --><!-- Content -->
<script>

    let choose_file_el = document.getElementById("choose_file");
    choose_file_el.addEventListener("click", function () {
        let my_input = document.getElementById("the_file");
        my_input.click(); //input type=flie 被點
    });
    window.addEventListener("load", function () {
        var the_file_element = document.getElementById("the_file");
        the_file_element.addEventListener("change", function (e) {
            let that = this;
            let ul_el = document.querySelector(".picture_list");
            ul_el.innerHTML = "";

            for (let i = 0; i < this.files.length; i++) {
                let reader = new FileReader();
                reader.readAsDataURL(this.files[i]);
                reader.addEventListener("load", function () {
                    let li_html2 = `<li>

                                                <input type="submit" class="submit" value="儲存">
                                        </li>`;

                    let html_img = document.getElementById("pic");
                    let html_newImg = document.createElement("img");
                    html_newImg.src = `${this.result}`;
                    html_newImg.id = "changeImg";
                    html_newImg.style = "width: 100%; height: 100%";
                    let html_oldImg = document.getElementById("memImg");
                    if (html_oldImg === null) {
                        html_oldImg = document.getElementById("changeImg")
                    }
                    console.log(html_oldImg);

                    html_img.replaceChild(html_newImg, html_oldImg);

                    ul_el.insertAdjacentHTML("beforeend", li_html2);
                });
            }
        });
    });

    // 處理表單提交並使用 AJAX 上傳新圖片
    function handleAvatarUpload(event) {
        event.preventDefault(); // 阻止默認提交行為

        // 使用 FormData 收集表單數據
        const formData = new FormData(event.target);

        // 使用 fetch 發送 POST 請求
        fetch('/frontend/member/newPicture', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json()) // 將回應解析為 JSON 格式
            .then(data => {
                if (data.success) {
                    // 上傳成功：更新頁面上的大頭貼圖片
                    const avatarElement = document.getElementById('memberAvatar');
                    avatarElement.src = data.newAvatarUrl; // 更新圖片的 src 屬性

                    // 顯示成功消息
                    alert('上傳成功！');

                    // 在上傳成功後進行重定向
                    window.location.href = '/frontend/member/memberData';
                } else {
                    // 上傳失敗：顯示錯誤消息
                    console.error('上傳失敗:', data.error);
                    alert('上傳失敗，請重試。');
                }
            })
            .catch(error => {
                // 請求過程中的錯誤處理
                console.error('錯誤:', error);
                alert('發生錯誤，請稍後重試。');
            });
    }
</script>