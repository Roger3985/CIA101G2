<!DOCTYPE html>
<html lang="zxx" data-bs-theme="light">

<head><!-- metas -->
    <meta charset="utf-8">
    <meta name="author" content="pxdraft">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <meta name="keywords" content="ShopApp - eCommerce Bootstrap 5 Template">
    <meta name="description" content="ShopApp - eCommerce Bootstrap 5 Template">
    <!-- title -->
    <title>ShopApp - eCommerce Bootstrap 5 Template</title>
    <!-- Favicon -->
    <link rel="shortcut icon" th:href="@{/logo/favicon.ico}">
    <!-- CSS Template -->
    <link th:href="@{/frontend/assets/css/style.css}" rel="stylesheet">

</head>

<body>
<!-- 通用插件 -->
<th:block th:replace="frontend/component/plugin/frontendplugin :: components"></th:block>
<!-- 通用插件 -->
<!--
========================
    Wrapper
========================
-->
<div class="wrapper">
    <!-- Header -->
    <header th:replace="frontend/component/header :: header"></header>
    <!-- End Header -->
    <!-- Main -->
    <main>
        <!-- Page Title -->
        <div class="bg-no-repeat bg-cover bg-right-center position-relative">
            <div class="position-absolute top-0 end-0 start-0 bottom-0 opacity-3 bg-dark"></div>
            <!-- Header Height Bar -->
            <div class="header-height-bar border-bottom opacity-3" style="min-height: 104.865px;"></div>
            <div class="container py-6 position-relative">
                <div class="row align-items-center">
                    <div class="col-lg-6 my-2">
                        <h1 class="m-0 h4 text-center text-lg-start text-white">Your cart</h1>
                    </div>
                    <div class="col-lg-6 my-2">
                        <ol
                                class="breadcrumb breadcrumb-light m-0 small justify-content-center justify-content-lg-end">
                            <li class="breadcrumb-item"><a class="text-nowrap" href="#">Home</a></li>
                            <li class="breadcrumb-item text-nowrap active" aria-current="page">Your cart</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </main>
        <!-- End Page Title -->
        <!-- Section -->

        <form th:action="@{/frontend/productorder/insertOrder}" method="post" th:object="${cartListData}">
            <table class="table">
                <thead>
                <tr>
                    <!--                <th>會員編號</th>-->
                    <!--                <th>商品編號</th>-->
                    <th>商品</th>
                    <th>顏色</th>
                    <th>大小</th>
                    <th>單價</th>
                    <th>數量</th>
                    <th>總計</th>
                    <th>操作</th>
                </tr>
                </thead>

                <tbody class="align-middle" id="parentOfProductAllPrice">
                <th:block th:each="cart: ${cartListData}">
                    <tr class="productitm">

                        <td class="align-middle" th:id="productName" th:text="${cart.productName}"></td>
                        <td class="align-middle" th:id="productColor" th:text="${cart.productColor}"></td>
                        <td id="productSize">
                            <span th:if="${cart.productSize == 0}">XS</span>
                            <span th:if="${cart.productSize == 1}">S</span>
                            <span th:if="${cart.productSize == 2}">M</span>
                            <span th:if="${cart.productSize == 3}">L</span>
                            <span th:if="${cart.productSize == 4}">XL</span>
                            <span th:if="${cart.productSize == 5}">2L</span>
                        </td>
                        <td class="price" th:id="productPrice" th:text="${cart.productPrice}"></td>
                        <td class="align-middle">
                            <div class="cart-qty-01">
                                <button type="button" class="inc qty-btn" onclick="decreaseQuantity(this)">
                                    <i class="bi bi-caret-down-fill"></i>
                                </button>
                                <input class="cart-qty-input form-control" type="text" name="productBuyQty"
                                       th:value="${cart.productBuyQty}">
                                <button type="button" class="dec qty-btn" onclick="increaseQuantity(this)">
                                    <i class="bi bi-caret-up-fill"></i>
                                </button>
                            </div>
                        </td>
                        <td class="align-middle allprice" th:id="productAllPrice"
                            th:text="'$' + ${cart.productBuyQty * cart.productPrice}" th:onchange="updatePrice()"></td>
                        <td class="align-middle">

                            <input type="hidden" name="productNo" th:value="${cart.productNo}"/>
                            <input type="hidden" name="memNo" th:value="${cart.memNo}"/>
                            <button class="btn btn-link px-0 text-danger btn btn-sm btn-primary btn-remove"
                                    type="button" onclick="deleteProduct(this)">
                                <i class="bi-trash3 me-2"></i>
                                <span class="">Remove</span>
                            </button>
                        </td>
                    </tr>
                </th:block>
                </tbody>

            </table>

            <div class="card">
                <div class="card-header bg-transparent py-3">
                    <h6 class="m-0 h5">商品金額</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="me-2 text-body">商品總金額</h6>
                            <h6 class="font-weight-medium text-end" id="allprice"></h6>
                        </li>
                    </ul>
                    <div class="pt-2 pb-4">
                        <div class="d-flex">

                            <button class="btn btn-dark btn-sm ms-2">結帳</button>
                        </div>
                    </div>

                </div>
            </div>
        </form>

            <div class="col-md-4 mb-5">
                <h5 class="font-weight-bold text-dark mb-4">Newsletter</h5>

            </div>



<!-- End Section -->
<!-- End Main -->
<!-- Footer -->
<footer th:replace="frontend/component/footer :: footer"></footer>
<!-- End Footer -->

<!-- Footer End -->

<!--
========================
   End Wrapper
========================
-->
<!-- script start -->
<th:block th:insert="~{frontend/component/plugin/frontendplugin.html :: js}"></th:block>
<!-- End script start -->

<!-- Back to Top -->
<a href="#" class="btn btn-primary back-to-top"><i class="fa fa-angle-double-up"></i></a>


<!-- JavaScript Libraries -->
<script th:src="@{https://code.jquery.com/jquery-3.4.1.min.js}"></script>
<script th:src="@{https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/frontend/lib/easing/easing.min.js}"></script>
<script th:src="@{/frontend/lib/owlcarousel/owl.carousel.min.js}"></script>

<!-- Contact Javascript File -->
<script th:src="@{/frontend/mail/jqBootstrapValidation.min.js}"></script>
<script th:src="@{/frontend/mail/contact.js}"></script>

<!-- Template Javascript -->

<script>
    // function updateTotal(input) {
    //     var quantity = parseInt(input.value);
    //     var priceElement = input.closest('.productitm').querySelector('.price');
    //     var totalPriceElement = input.closest('.productitm').querySelector('.allprice');
    //     var price = parseFloat(priceElement.textContent.replace('$', '')); // 获取价格并转换为浮点数
    //     var total = price * quantity; // 计算总价
    //     totalPriceElement.textContent = '$' + total; // 更新总价，并保留两位小数
    //     calculateTotalAllPrice(); // 更新总价
    //     saveTotalPrice(); // 保存总价到会话存储中
    // }
    document.getElementById('decreaseQuantityBtn').addEventListener('click', function () {
        decreaseQuantity(this);
    });

    document.getElementById('increaseQuantityBtn').addEventListener('click', function () {
        increaseQuantity(this);
    });


    function decreaseQuantity(button) {
        var input = button.nextElementSibling;
        var quantity = parseInt(input.value);
        if (quantity > 1) {
            var newValue = quantity - 1;
            input.value = newValue;
            // updateTotal(); // 更新总价
            // updateBackendQuantity(input, newValue); // 更新后端数据
        }
    }

    function increaseQuantity(button) {
        var input = button.previousElementSibling;
        var quantity = parseInt(input.value);
        var newValue = quantity + 1;
        input.value = newValue;
        // updateTotal(); // 更新总价
        // updateBackendQuantity(input, newValue); // 更新后端数据
    }


    // 发送 AJAX 请求更新数量到后端
    var productNo = input.dataset.productNo; // 使用自定义属性获取商品编号
    var memNo = input.dataset.memNo; // 使用自定义属性获取会员编号

    //     // 发送 AJAX 请求
    //     $.post("/updateQuantity", {
    //         productNo: productNo,
    //         memNo: memNo,
    //         quantity: newValue
    //     }).done(function(response) {
    //         // 处理成功的情况
    //         console.log("Quantity updated successfully");
    //     }).fail(function(error) {
    //         // 处理失败的情况
    //         console.error("Failed to update quantity");
    //     });
    //     updateBackendQuantity(input, newValue); // 更新后端数据
    // }

    //
    //     function calculateTotalAllPrice() {
    //         var allPriceElements = document.querySelectorAll('#parentOfProductAllPrice .allprice');
    //         var totalAllPrice = 0;
    //         allPriceElements.forEach(function(element) {
    //             var price = parseFloat(element.textContent.replace('$', '')); // 获取元素的文本内容并去除货币符号
    //             totalAllPrice += price;
    //         });
    //         var totalPriceElement = document.getElementById('allprice');
    //         totalPriceElement.textContent = '$' + totalAllPrice.toFixed(2); // 保留两位小数并添加货币符号
    //     }
    //
    //     // 发送 AJAX 请求更新数量到后端
    //     var productNo = input.dataset.productNo; // 使用自定义属性获取商品编号
    //     var memNo = input.dataset.memNo; // 使用自定义属性获取会员编号
    //
    //     // 发送 AJAX 请求
    //     $.post("/updateQuantity", {
    //         productNo: productNo,
    //         memNo: memNo,
    //         quantity: newValue
    //     }).done(function(response) {
    //         // 处理成功的情况
    //         console.log("Quantity updated successfully");
    //     }).fail(function(error) {
    //         // 处理失败的情况
    //         console.error("Failed to update quantity");
    //     });
    // }
    // function saveTotalPrice() {
    //     var totalAllPrice = document.getElementById('allprice').textContent.replace('$', ''); // 获取总价并去除货币符号
    //     sessionStorage.setItem('totalPrice', totalAllPrice);
    //
    // }
    //
    // // 页面加载时执行一次计算
    // calculateTotalAllPrice();
    //
    //
    // // 创建一个 MutationObserver 实例
    // var observer = new MutationObserver(function(mutationsList, observer) {
    //     calculateTotalAllPrice(); // 更新总价
    //     saveTotalPrice(); // 保存总价到会话存储中
    // });
    //
    // // 选择要观察的节点
    // var targetNode = document.getElementById('parentOfProductAllPrice');
    //
    // // 配置观察器选项
    // var config = { subtree: true, childList: true };
    //
    // // 启动观察器并传入要观察的节点和配置
    // observer.observe(targetNode, config);
    //
    // // 更新后端数量
    // function updateBackendQuantity(input, newValue) {
    //     var productNo = input.dataset.productNo; // 使用自定义属性获取商品编号
    //     var memNo = input.dataset.memNo; // 使用自定义属性获取会员编号
    //     $.post("/frontend/cart/updateQuantity", {
    //         productNo: productNo,
    //         memNo: memNo,
    //         quantity: newValue
    //     }).done(function(response) {
    //         console.log("Quantity updated successfully");
    //     }).fail(function(error) {
    //         console.error("Failed to update quantity");
    //     });
    // }
    //
    function deleteProduct(button) {
        var row = button.closest('.productitm'); // 获取最近的行元素
        var productNo = row.querySelector('input[name="productNo"]').value; // 获取要删除的商品编号
        var memNo = row.querySelector('input[name="memNo"]').value; // 获取会员编号

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/frontend/cart/deleteInstantly', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.onload = function() {
            if (xhr.status === 200 && xhr.responseText === "success") {
                // 从 DOM 中移除该行
                row.remove();
                // 重新加载页面
                location.reload();
            } else {
                // 处理删除失败的情况
                console.error('删除失败');
            }
        };
        xhr.send('productNo=' + encodeURIComponent(productNo) + '&memNo=' + encodeURIComponent(memNo));
    }




    // 发送请求


    <!--        xhr.send();-->
    <!--    }-->

</script>
</body>

</html>
