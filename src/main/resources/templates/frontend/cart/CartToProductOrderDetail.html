<html lang="zxx" data-bs-theme="light" xmlns="http://www.w3.org/1999/html">

<head>
    <meta charset="utf-8">
    <meta name="author" content="pxdraft">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <meta name="keywords" content="ShopApp - eCommerce Bootstrap 5 Template">
    <meta name="description" content="ShopApp - eCommerce Bootstrap 5 Template">
    <title>ShopApp - eCommerce Bootstrap 5 Template</title>
    <link rel="shortcut icon" th:href="@{/logo/favicon.ico}">
    <link th:href="@{/frontend/assets/css/style.css}" rel="stylesheet">
    <style>
        .coupon {
            padding: 20px;
            background-color: #fff;
            border: 2px dashed #f69314;
            border-radius: 10px;
            font-size: 20px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .coupon:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .coupon strong {
            font-size: 24px;
            color: #f69314;
            margin-top: 10px;
            display: block;
        }

        .coupon p {
            margin: 0;
            color: #333;
        }

        input[type=submit] {
            padding: 10px 20px;
            background-color: #f69314;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        .header-height-bar {
            min-height: 104.865px;
        }

        .breadcrumb {
            background: none;
        }

        .breadcrumb .breadcrumb-item + .breadcrumb-item::before {
            content: ">";
        }

        .breadcrumb-item a {
            text-decoration: none;
            color: black;
        }

        .breadcrumb-item.active {
            color: black;
        }

        .page-title {
            background-color: #e1f5fe;
            color: black;
            padding: 20px 0;
        }

        .page-title h1 {
            color: black;
        }

        .breadcrumb-light .breadcrumb-item a {
            color: black;
        }

        .breadcrumb-light .breadcrumb-item.active {
            color: black;
        }

        .section {
            padding: 30px 0;
        }

        .section .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .section h6 {
            color: #000;
        }

        .form-control {
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ced4da;
        }

        .btn-primary {
            background-color: #e57373;
            border-color: #e57373;
        }

        .btn-primary:hover {
            background-color: #f06292;
            border-color: #f06292;
        }

        .list-group-item {
            border: none;
            padding: 10px 0;
        }

        .card {
            margin-top: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
        }

        .card-body {
            padding: 20px;
        }

        .order-button-payment input[type=button] {
            background-color: #000;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 15px 30px;
            font-size: 18px;
        }

        .order-button-payment input[type=button]:hover {
            background-color: #333;
        }
    </style>
</head>

<body>
<!-- 通用插件 -->
<th:block th:replace="frontend/component/plugin/frontendplugin :: components"></th:block>
<!-- 通用插件 -->
<!--
========================
    Wrapper
========================
-->
<div class="wrapper">
    <div class="header-height-bar"></div>
    <header th:replace="frontend/component/header :: header"></header>
    <main>
        <div class="page-title bg-no-repeat bg-cover bg-right-center position-relative">
            <div class="container py-6 position-relative">
                <div class="row align-items-center">
                    <div class="col-lg-6 my-2">
                        <h1 class="m-0 h4 text-center text-lg-start">Your cart</h1>
                    </div>
                    <div class="col-lg-6 my-2">
                        <ol class="breadcrumb breadcrumb-light m-0 small justify-content-center justify-content-lg-end">
                            <li class="breadcrumb-item"><a class="text-nowrap" href="#">Home</a></li>
                            <li class="breadcrumb-item text-nowrap active" aria-current="page">Your cart</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
        <section class="section">
            <div class="container">
                <div class="row align-items-start">
                    <div class="col-md-4">
                        <form id="submitOrderForm" th:action="@{/frontend/productorder/insertProductOrderSuccess}" method="post">
                            <h6 class="mb-4 h3">寄送資訊</h6>
                            <div>
                                <label>訂購人姓名: <span class="required">*</span></label>
                                <input class="form-control" type="text" name="productByrName" id="productByrName" th:value="${productOrder.member.memName}">
                                <span id="productByrName-error" class="error-message"></span>
                            </div>
                            <div>
                                <label>訂購人手機號碼:<span class="required">*</span></label>
                                <input class="form-control" type="text" name="productByrPhone" id="productByrPhone" th:value="${productOrder.member.memMob}">
                                <span id="productByrPhone-error" class="error-message"></span>
                            </div>
                            <div>
                                <label>訂購人Email:<span class="required">*</span></label>
                                <input class="form-control" type="email" name="productByrEmail" id="productByrEmail" placeholder="請輸入電子信箱" th:value="${productOrder.member.memMail}">
                                <span id="productByrEmail-error" class="error-message"></span>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-4">
                        <div>
                            <input type="checkbox" id="copyInfo" onclick="copyBuyerInfo(this)">
                            <label for="copyInfo">同訂購人</label>
                        </div>
                        <div>
                            <label>收件人姓名: <span class="unrequired"></span></label>
                            <input class="form-control" type="text" name="productRcvName" id="productRcvName" th:value="${productOrder.productRcvName}">
                            <span id="productRcvName-error" class="error-message"></span>
                        </div>
                        <div>
                            <label>收件人手機號碼:<span class="unrequired"></span></label>
                            <input class="form-control" type="text" name="productRcvPhone" id="productRcvPhone" th:value="${productOrder.productRcvPhone}">
                            <span id="productRcvPhone-error" class="error-message"></span>
                        </div>
                        <div>
                            <label>取貨方式:</label>
                            <select class="form-control" th:id="productTakeMethod" th:field="*{productOrder.productTakeMethod}" th:name="productTakeMethod">
                                <option value="">請選擇</option>
                                <option th:value="1" th:text="店取"></option>
                                <option th:value="2" th:text="宅配"></option>
                                <option th:value="3" th:text="超商取貨"></option>
                            </select><br />
                        </div>
                        <div class="col-md-12">
                            <div class="checkout-form-list">
                                <label for="productAddr">宅配住址: <span class="unrequired"></span></label>
                                <input id="productAddr" class="form-control" placeholder="請輸入地址" type="text" th:name="productAddr" th:value="${productOrder.member.memAdd}">
                                <span id="productAddr-error" class="error-message"></span>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="checkout-form-list">
                                <label>付款方式:</label>
                                <select class="form-control" th:id="productPayMethod" th:field="*{productOrder.productPayMethod}" th:name="productPayMethod">
                                    <option value="">請選擇</option>
                                    <option th:value="1" th:text="線上刷卡"></option>
                                    <option th:value="2" th:text="現場付款"></option>
                                </select>
                                <br />
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="mb-4 h3">商品訂單明細</h6>
                        <ul class="list-group mb-6">
                            <li class="list-group-item p-3" th:each="productOrderDetail : ${productOrder.ProductOrderDetails}">
                                <div class="row g-2">
                                    <div>
                                        <img th:src="'data:image/png;base64,' + ${session['productImage' + productOrderDetail.product.productNo]}" alt="Product Picture" style="width: auto; height: 80px;" />
                                        <span th:text="${productOrderDetail.product.productName}" style="font-size: larger;"></span>
                                    </div>
                                    <div>
                                        &nbsp;&nbsp;&nbsp;規格:
                                        <span th:text="${productOrderDetail.product.productColor}"></span>
                                        <span th:if="${productOrderDetail.product.productSize == 0}">XS</span>
                                        <span th:if="${productOrderDetail.product.productSize == 1}">S</span>
                                        <span th:if="${productOrderDetail.product.productSize == 2}">M</span>
                                        <span th:if="${productOrderDetail.product.productSize == 3}">L</span>
                                        <span th:if="${productOrderDetail.product.productSize == 4}">XL</span>
                                        <span th:if="${productOrderDetail.product.productSize == 5}">2L</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <span>價錢:</span>&nbsp;&nbsp;&nbsp;
                                        <span th:text="'$ ' + ${productOrderDetail.productPrice}" th:field="*{productOrderDetail.productPrice}"></span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <span>數量:</span>&nbsp;&nbsp;&nbsp;
                                        <span th:text="${productOrderDetail.productOrdQty} + ' 個'" th:field="*{productOrderDetail.productOrdQty}"></span>
                                    </div>
                                </div>
                            </li>
                        </ul>
                        <div class="col-sm-3 form-control">
                            <div class="checkout-form-list">
                                <label for="coupNo">請輸入優惠券編號</label>
                                <select class="form-control" size="1" name="coupNo" id="coupNo" onchange="updatePriceInstantly()">
                                    <option value="1">請選擇</option>
                                    <option th:each="mycoupon : ${coupons}" th:value="${mycoupon.coupon.coupNo}" th:text="${mycoupon.coupon.coupName+'優惠券折數: ' + mycoupon.coupon.coupDisc}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="card bg-light">
                            <div class="card-body py-0 px-4">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex bg-transparent px-0 py-3">
                                        <span>總價：</span>
                                        <span class="ms-auto" id="productAllPrice" th:name="productAllPrice" th:text="${productOrder.productAllPrice}" th:value="${productOrder.productAllPrice}"></span>
                                    </li>
                                    <li class="list-group-item d-flex bg-transparent px-0 py-3">
                                        <span>折價：</span>
                                        <span class="ms-auto" id="productDisc" th:name="productDisc" th:text="${productOrder.productDisc}" th:value="${productOrder.productDisc}"></span>
                                    </li>
                                    <li class="list-group-item d-flex bg-transparent px-0 py-3 fs-lg fw-600">
                                        <span>實際金額：</span>
                                        <span class="ms-auto" id="productRealPrice" name="productRealPrice" th:text="${productOrder.productRealPrice}" th:value="${productOrder.productRealPrice}"></span>
                                    </li>
                                </ul>
                            </div>
                            <div class="order-button-payment mt-3">
                                <input value="提交訂單" type="button" id="submitOrderBtn" onclick="SubmitToPay(this)" class="btn btn-primary btn-block w-100">
                            </div>
                        </div>
                    </div>
                    <div id="ecpayFormContainer"></div>
                </div>
            </div>
        </section>
    </main>
</div>
<div id="loading" style="display: none;">提交中...</div>

<!-- End Main -->

<!-- Footer -->
<footer th:replace="frontend/component/footer :: footer"></footer>
<!-- End Footer -->
</div>
<!--
========================
   End Wrapper
========================
-->
<!-- script start -->
<th:block th:insert="~{frontend/component/plugin/frontendplugin.html :: js}"></th:block>
<!-- End script start -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script th:inline="javascript">
    // 获取选择框元素



    function updatePriceInstantly() {
        var coupNo = document.getElementById('coupNo').value; // 获取优惠券编号的值
        var productDisc = document.getElementById('productDisc').innerText; // 获取产品折扣的值
        var productRealPrice = document.getElementById('productRealPrice').innerText; // 获取产品实际价格的值
        var productAllPrice = document.getElementById('productAllPrice').innerText; // 获取产品总价格的值

        // 发送 AJAX 请求更新数量到后端
        $.ajax({
            type: 'POST',
            url: '/frontend/cart/coupNoInstantly',
            data: {
                coupNo: coupNo,
                productDisc: productDisc,
                productRealPrice: productRealPrice,
                productAllPrice: productAllPrice
            },
            success: function (data) {
                console.log("更新優惠券總價成功");

                // 在这里，你可以根据后端返回的数据更新前端页面上对应的元素，例如更新实际价格和折扣价格的显示
                document.getElementById('productRealPrice').innerText = data.productRealPrice;
                document.getElementById('productDisc').innerText = data.productDisc;
            },
            error: function () {
                console.error('更新失败');
            }
        });
    }

    function copyBuyerInfo(checkbox) {
        var byrName = document.getElementById("productByrName").value;
        var byrPhone = document.getElementById("productByrPhone").value;
        var rcvNameInput = document.getElementById("productRcvName");
        var rcvPhoneInput = document.getElementById("productRcvPhone");

        if (checkbox.checked) {
            rcvNameInput.value = byrName;
            rcvPhoneInput.value = byrPhone;
        } else {
            rcvNameInput.value = "";
            rcvPhoneInput.value = "";
        }
    }

    // 提取表单验证逻辑为单独的函数
    function validateForm() {
        var productByrName = document.getElementById('productByrName').value;
        var productByrPhone = document.getElementById('productByrPhone').value;
        var productByrEmail = document.getElementById('productByrEmail').value;
        var productTakeMethod = document.getElementById('productTakeMethod').value;
        var productPayMethod = document.getElementById('productPayMethod').value;
        var productAddr = document.getElementById('productAddr').value; // 获取地址输入框的值
        var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; // 檢查電子郵件地址的正則表達式

        // 檢查訂購人姓名是否為非空
        if (productByrName.trim() === '') {
            alert('訂購人姓名不能為空');
            return false;
        }
        if (productTakeMethod.trim() === '') {
            alert('請選擇運送方式');
            return false;
        }
        if (productPayMethod.trim() === '') {
            alert('請選擇付款方式');
            return false;
        }


        // 檢查手機號碼是否為非空且僅包含數字
        if (!/^09\d{8}$/.test(productByrPhone)) {
            alert('訂購人手機號碼不正確,請輸入09開頭電話號碼');
            return false;
        }

        // 檢查電子郵件地址是否為非空且符合格式
        if (productByrEmail.trim() === '' || !emailRegex.test(productByrEmail)) {
            alert('訂購人Email不正確');
            return false;
        }


        if (productTakeMethod === '2' && productAddr.trim() === '') {
            alert('宅配住址不能為空');
            return false;
        }

        // 如果通過了上述檢查，返回 true，允許提交表單
        return true;
    }



    function SubmitToPay(input) {
        // 先進行表單驗證
        if (!validateForm()) {
            return; // 如果驗證不通過，直接返回
        }

        var productByrName = document.querySelector('#productByrName').value;
        var productByrPhone = document.querySelector('#productByrPhone').value;
        var productByrEmail = document.querySelector('#productByrEmail').value;
        var productRcvPhone = document.querySelector('#productRcvPhone').value;
        var productRcvName = document.querySelector('#productRcvName').value;
        var productTakeMethod = document.querySelector('select[name="productTakeMethod"]').value;
        var productAddr = document.querySelector('#productAddr').value;
        var productPayMethod = document.querySelector('select[name="productPayMethod"]').value;
        var coupNo = document.querySelector('select[name="coupNo"]').value;
        var productAllPrice = document.getElementById('productAllPrice').innerText;

        if (productPayMethod === '2') { // 如果付款方式為"現場付款"
            // 使用 AJAX 提交訂單
            $.ajax({
                type: 'POST',
                url: '/frontend/productorder/insertProductOrderSuccess',
                data: {
                    productByrName: productByrName,
                    productByrPhone: productByrPhone,
                    productByrEmail: productByrEmail,
                    productRcvName: productRcvName,
                    productRcvPhone: productRcvPhone,
                    productTakeMethod: productTakeMethod,
                    productAddr: productAddr,
                    productPayMethod: productPayMethod,
                    coupNo: coupNo,
                    productAllPrice: productAllPrice,
                },
                success: function (result) {
                    // 在這裡，result應該是伺服器返回的訂單號或其他信息
                    // 跳轉到訂單成功頁面
                    window.location.href = '/frontend/cart/ProductOrderSuccessful';
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        } else {
            // 使用 AJAX 提交訂單
            $.ajax({
                type: 'POST',
                url: '/frontend/productorder/submitOrder',
                data: {
                    productByrName: productByrName,
                    productByrPhone: productByrPhone,
                    productByrEmail: productByrEmail,
                    productRcvName: productRcvName,
                    productRcvPhone: productRcvPhone,
                    productTakeMethod: productTakeMethod,
                    productAddr: productAddr,
                    productPayMethod: productPayMethod,
                    coupNo: coupNo,
                    productAllPrice: productAllPrice,
                },
                success: function (result) {
                    // 在這裡，result應該是伺服器返回的支付鏈接
                    let formContainer = document.getElementById("ecpayFormContainer");
                    // 設置表單的HTML內容為支付鏈接
                    formContainer.innerHTML = result;
                    // 提交表單
                    formContainer.querySelector('form').submit();
                },
                error: function (xhr, status, error) {
                    console.error(xhr.responseText);
                }
            });
        }
    }



    function checkInputs() {
        let isValid = true;
        let requiredFields = [
            '#productByrName',
            '#productByrPhone',
            '#productByrEmail'
        ];
        requiredFields.forEach(function (field) {
            if ($(field).val() === '') {
                $(field).next('.error-message').text('此字段為必填');
                isValid = false;
            } else {
                $(field).next('.error-message').text('');
            }
        });
        return isValid;
    }

</script>
</body>

</html>