<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ListAll</title>
    <link rel="shortcut icon" th:href="@{/logo/favicon.ico}">
    <th:block th:include="~{backend/component/plugin/backendplugin.html :: css}"></th:block>
    <link th:href="@{/backend/vendor/datatables/dataTables.bootstrap4.min.css}" rel="stylesheet" />
    <style>
        /* 限制圖片寬度和高度 */
        img {
            max-width: 100px; /* 根據你的需要調整寬度 */
            max-height: 100px; /* 根據你的需要調整高度 */
            object-fit: cover; /* 確保圖片按比例縮放 */
        }
        .preview-img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            margin: 10px;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 5px;
        }
        .preview-container {
            display: flex;
            flex-wrap: wrap;
        }
        .progress-container {
            position: relative;
        }
        .progress-container .progress-bar {
            display: none;
        }
    </style>
</head>
<body id="page-top">
<div th:replace="backend/component/loading :: loading"></div>
<div id="wrapper">
    <ul th:replace="backend/component/sidebar :: sidebar"></ul>
    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <nav th:replace="backend/component/nav :: nav"></nav>
            <div class="container-fluid">
                <div th:replace="backend/component/breadcrumb :: breadcrumb"></div>
                <!-- 內容請寫在這裡呦~~~~ -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">全部商品照片資料:</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                                <thead>
                                <tr>
                                    <th>商品照片編號</th>
                                    <th>商品編號</th>
                                    <th>商品圖片</th>
                                    <th>圖片格式</th>
                                    <th>修改</th>
                                </tr>
                                </thead>
                                <tbody>
                                <th:block th:each="productPicture : ${productPictureList}">
                                    <tr>
                                        <td th:text="${productPicture.productPicNo}"></td>
                                        <td th:text="${productPicture.product.productNo + ' : ' + productPicture.product.productName}"></td>
                                        <td>
                                            <div class="progress-container">
                                                <div th:attr="id='progress-bar-' + ${productPicture.productPicNo}" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                            </div>
                                            <img th:if="${productPicture.productPic != null}" th:attr="id='img-' + ${productPicture.productPicNo}" th:src="@{/backend/productpicture/DBPhotoReader(productPicNo=${productPicture.productPicNo})}" alt="Profile Picture" style="display:none;">
                                            <button th:if="${productPicture.productPic == null}" class="btn btn-primary upload-btn" th:attr="data-product-no=${productPicture.product.productNo}, data-product-pic-no=${productPicture.productPicNo}">
                                                <i class="far fa-edit"></i> 上傳圖片
                                            </button>
                                        </td>
                                        <td th:text="${productPicture.mimeType}"></td>
                                        <td>
                                            <form method="get" th:action="@{updateProductPicture}">
                                                <input type="hidden" name="productPicNo" th:value="${productPicture.productPicNo}">
                                                <button type="submit">
                                                    <i class="far fa-edit"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                </th:block>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer th:replace="backend/component/bottom :: bottom"></footer>
        <div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="uploadModalLabel">上傳圖片</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="uploadForm">
                            <div class="form-group">
                                <label for="images">選擇圖片</label>
                                <input type="hidden" id="productNo" name="productNo">
                                <input type="file" id="images" name="productPic" multiple accept="image/*" class="form-control">
                            </div>
                            <div id="preview-container" class="row preview-container"></div>
                            <button type="button" id="uploadButton" class="btn btn-primary mt-3">上傳</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<a th:replace="backend/component/scrolltotop :: scrolltotop"></a>
<div th:replace="backend/component/logout :: logout"></div>
<th:block th:insert="~{backend/component/plugin/backendplugin.html :: js}"></th:block>

<script>
    var stompClient = null;
    var currentUserAdmNo = null;
    var currentProductNo = null;
    var currentProductPicNo = null;

    function connect() {
        var socket = new SockJS('/admin');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('已連接: ' + frame);
            subscribeToUserQueue();
        });
    }

    function fetchCurrentUser() {
        return fetch('/backend/getCurrentUser')
            .then(response => response.json())
            .then(data => {
                currentUserAdmNo = data;
                console.log('當前用戶 admNo: ' + currentUserAdmNo);
                connect();
            });
    }

    function subscribeToUserQueue() {
        var queue = '/queue/user-' + currentUserAdmNo;
        stompClient.subscribe(queue, function (message) {
            var messageObject = JSON.parse(message.body);
            console.log('收到消息: ' + message.body);
            updateProgress(messageObject);
        });
    }

    function updateProgress(message) {
        var progressBar = document.getElementById('progress-bar-' + message.productPicNo);
        progressBar.style.width = message.progress + '%';
        progressBar.setAttribute('aria-valuenow', message.progress);
        progressBar.textContent = message.progress + '%';

        if (message.progress === 100) {
            alert('上傳完成');
            showImage(message.productPicNo);
        }
    }

    function showImage(productPicNo) {
        var progressBar = document.getElementById('progress-bar-' + productPicNo);
        progressBar.style.display = 'none';

        var img = document.getElementById('img-' + productPicNo);
        img.style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', function () {
        const imagesInput = document.getElementById("images");
        const previewContainer = document.getElementById("preview-container");
        const uploadButton = document.getElementById("uploadButton");
        const productNoField = document.getElementById("productNo");
        let currentProductNo = null;

        document.querySelectorAll('.upload-btn').forEach(button => {
            button.addEventListener('click', function() {
                const productNoString = button.getAttribute('data-product-no');
                currentProductNo = parseInt(productNoString, 10); // 確保這是整數
                if (isNaN(currentProductNo)) {
                    console.error("無效的商品編號: ", productNoString);
                    alert("無效的商品編號，請重試。");
                    return;
                }
                productNoField.value = currentProductNo;
                console.log("Current productNo: " + currentProductNo); // 調試日誌
                $('#uploadModal').modal('show');
            });
        });

        imagesInput.addEventListener("change", function() {
            // 清空先前的預覽圖片
            previewContainer.innerHTML = "";
            const files = imagesInput.files;

            if (files) {
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement("img");
                        img.src = e.target.result;
                        img.classList.add("preview-img");
                        previewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        uploadButton.addEventListener("click", function() {
            const files = imagesInput.files;

            if (files.length === 0) {
                alert("請選擇圖片");
                return;
            }

            Array.from(files).forEach(file => {
                uploadFileInChunks(file, currentProductNo);
            });
        });

        function uploadFileInChunks(file, productNo) {
            const chunkSize = 1024 * 1024; // 1MB
            const totalChunks = Math.ceil(file.size / chunkSize);
            let chunkNumber = 0;

            function uploadNextChunk() {
                const start = chunkNumber * chunkSize;
                const end = Math.min(start + chunkSize, file.size);
                const chunk = file.slice(start, end);

                const formData = new FormData();
                formData.append("productNo", productNo); // 以整數形式傳送
                formData.append("productPic", chunk);
                formData.append("chunkNumber", chunkNumber + 1);
                formData.append("totalChunks", totalChunks);

                fetch('/backend/productpicture/uploadChunk', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { throw new Error(text) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            chunkNumber++;
                            if (chunkNumber < totalChunks) {
                                uploadNextChunk();
                            } else {
                                console.log('文件上傳完成');
                                $('#uploadModal').modal('hide');
                                showImage(productNo);
                            }
                        } else {
                            console.error('塊上傳失敗:', data.message);
                            alert('塊上傳失敗: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('上傳塊時發生錯誤:', error);
                        alert('上傳塊時發生錯誤: ' + error);
                    });
            }

            uploadNextChunk();
        }
    });
</script>
</body>
</html>
